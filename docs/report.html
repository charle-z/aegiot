<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AegIoT Report Viewer</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        .report {
            background: rgba(233, 239, 246, 0.96);
            border-radius: 14px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.14);
            color: #0b1220;
            line-height: 1.65;
            max-width: 1100px;
            margin: 16px auto 0;
        }

        .report.dark {
            background: #0c1320;
            color: #e2e8f0;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.45);
        }

        .report h1 {
            margin: 0 0 12px;
            font-size: 28px;
        }

        .report h2 {
            margin: 24px 0 10px;
            font-size: 20px;
        }

        .report h3 {
            margin: 18px 0 8px;
            font-size: 16px;
        }

        .report h1,
        .report h2,
        .report h3,
        .report h4,
        .report h5,
        .report h6 {
            color: #0b1220;
        }

        .report.dark h1,
        .report.dark h2,
        .report.dark h3,
        .report.dark h4,
        .report.dark h5,
        .report.dark h6 {
            color: #e2e8f0;
        }

        .report p {
            margin: 10px 0;
        }

        .report a {
            color: #2563eb;
        }

        .report.dark a {
            color: #7aa7d9;
        }

        .report code {
            color: #0b1220;
            background: #eef2f7;
            padding: 0 4px;
            border-radius: 4px;
        }

        .report.dark code {
            color: #e2e8f0;
            background: #0f172a;
        }

        .report pre {
            overflow-x: auto;
            background: #eef2f7;
            padding: 12px;
            border-radius: 10px;
            color: #0b1220;
        }

        .report.dark pre {
            background: #0f172a;
            color: #e2e8f0;
        }

        .report blockquote {
            margin: 12px 0;
            padding: 8px 12px;
            border-left: 3px solid #3b7c86;
            background: #f1f5f9;
            color: #1f2937;
        }

        .report.dark blockquote {
            background: #0f1a2b;
            color: #e2e8f0;
        }

        .report hr {
            border: 0;
            border-top: 1px solid #e2e8f0;
            margin: 20px 0;
        }

        .report.dark hr {
            border-top-color: #1f2a3a;
        }

        .report table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            color: #0b1220;
            font-size: 13px;
        }

        .report table td:first-child {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 12px;
        }

        .report thead th {
            position: sticky;
            top: 0;
            background: #f1f5f9;
            z-index: 1;
        }

        .report th,
        .report td {
            border: 1px solid #e2e8f0;
            padding: 6px 8px;
            text-align: left;
        }

        .report tbody tr:nth-child(odd) {
            background: #f6f8fb;
        }

        .report.dark table {
            color: #e2e8f0;
        }

        .report.dark thead th {
            background: #0f172a;
        }

        .report.dark th,
        .report.dark td {
            border-color: #1f2a3a;
        }

        .report.dark tbody tr:nth-child(odd) {
            background: #0b1424;
        }

        .report .badge {
            background: #eef2f7;
            border-color: #cbd5e1;
            color: #0b1220;
        }

        .report .badge.low {
            background: #e7f7ee;
            border-color: #86efac;
            color: #14532d;
        }

        .report .badge.medium {
            background: #fff4d6;
            border-color: #facc15;
            color: #713f12;
        }

        .report .badge.high {
            background: #ffe8d6;
            border-color: #fdba74;
            color: #7c2d12;
        }

        .report .badge.critical {
            background: #ffe4e6;
            border-color: #fecaca;
            color: #7f1d1d;
        }

        .report.dark .badge {
            background: #0f1a2b;
            border-color: #1f2a3a;
            color: #e2e8f0;
        }

        .report.dark .badge.low {
            background: #0e2a1d;
            border-color: #1f4732;
            color: #86efac;
        }

        .report.dark .badge.medium {
            background: #2a240f;
            border-color: #5a4a1a;
            color: #fde68a;
        }

        .report.dark .badge.high {
            background: #331a0b;
            border-color: #7c2d12;
            color: #fdba74;
        }

        .report.dark .badge.critical {
            background: #2c1116;
            border-color: #7f1d1d;
            color: #fecaca;
        }

        .toc-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
            display: grid;
            gap: 6px;
        }

        .toc-link {
            color: var(--text);
            text-decoration: none;
        }

        .toc-link:hover {
            text-decoration: underline;
        }

        .toc-indent {
            margin-left: 12px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">AegIoT</div>
            <nav class="nav">
                <a data-nav="index" data-i18n="nav.overview" href="index.html">Overview</a>
                <a data-nav="dashboard" data-i18n="nav.dashboard" href="dashboard.html">Dashboard</a>
                <a data-nav="report-before" data-i18n="nav.report_before" href="report.html?file=reports/before.md">Report (Before)</a>
                <a data-nav="report-after" data-i18n="nav.report_after" href="report.html?file=reports/after.md">Report (After)</a>
                <a data-nav="report-diff" data-i18n="nav.report_diff" href="report.html?file=reports/diff.md">Report (Diff)</a>
            </nav>
            <div class="sidebar-footer muted" data-i18n="report.markdown_note">Markdown rendered in-browser.</div>
        </aside>

        <main class="content">
            <div class="topbar">
                <div>
                    <h1 class="page-title" data-i18n="report.title">Report Viewer</h1>
                    <div id="file-label" class="muted"></div>
                </div>
                <div class="actions">
                    <a class="btn secondary" data-i18n="common.back_dashboard" href="dashboard.html">Back to dashboard</a>
                    <button class="btn secondary" id="report-theme-toggle" type="button" data-i18n="report.toggle_dark">Dark report</button>
                    <button class="btn secondary" id="lang-toggle" type="button">ES</button>
                </div>
            </div>

            <div id="status" class="muted" data-i18n="report.status_loading">Loading report...</div>

            <section class="card" id="toc-card" style="margin-top: 16px; display:none;">
                <h2 data-i18n="report.contents">Contents</h2>
                <ul id="toc-list" class="toc-list"></ul>
            </section>

            <article id="report" class="report" style="margin-top: 16px;"></article>
        </main>
    </div>

    <script src="i18n.js"></script>
    <script src="nav.js"></script>
    <script>
        (function () {
            var params = new URLSearchParams(window.location.search);
            var file = params.get("file") || "";
            var statusEl = document.getElementById("status");
            var reportEl = document.getElementById("report");
            var fileLabel = document.getElementById("file-label");
            var tocCard = document.getElementById("toc-card");
            var tocList = document.getElementById("toc-list");
            var themeToggle = document.getElementById("report-theme-toggle");
            var reportTheme = localStorage.getItem("report_theme") || "light";

            function t(key, fallback) {
                if (window.i18n && window.i18n.t) return window.i18n.t(key);
                return fallback || key;
            }

            function applyTheme() {
                if (reportTheme === "dark") {
                    reportEl.classList.add("dark");
                } else {
                    reportEl.classList.remove("dark");
                }
                if (themeToggle) {
                    themeToggle.textContent = reportTheme === "dark" ? t("report.toggle_light", "Light report") : t("report.toggle_dark", "Dark report");
                }
            }

            if (themeToggle) {
                themeToggle.addEventListener("click", function () {
                    reportTheme = reportTheme === "dark" ? "light" : "dark";
                    localStorage.setItem("report_theme", reportTheme);
                    applyTheme();
                });
            }

            function isSafePath(path) {
                if (!path) return false;
                if (path.indexOf("://") !== -1) return false;
                if (path.indexOf("..") !== -1) return false;
                if (path.indexOf("\\") !== -1) return false;
                if (path[0] === "/") return false;
                if (path.indexOf("reports/") !== 0) return false;
                if (path.slice(-3) !== ".md") return false;
                return true;
            }

            function slugify(text) {
                return text.toLowerCase().trim().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
            }

            function buildToc() {
                tocList.innerHTML = "";
                var headers = reportEl.querySelectorAll("h2, h3");
                if (!headers.length) {
                    tocCard.style.display = "none";
                    return;
                }
                var used = {};
                headers.forEach(function (h) {
                    var base = slugify(h.textContent || "section");
                    var id = base || "section";
                    var idx = 2;
                    while (used[id]) {
                        id = base + "-" + idx;
                        idx += 1;
                    }
                    used[id] = true;
                    h.id = id;

                    var li = document.createElement("li");
                    if (h.tagName === "H3") {
                        li.className = "toc-indent";
                    }
                    var a = document.createElement("a");
                    a.className = "toc-link";
                    a.href = "#" + id;
                    a.textContent = h.textContent;
                    li.appendChild(a);
                    tocList.appendChild(li);
                });
                tocCard.style.display = "block";
            }

            function applyBadges() {
                var levels = ["CRITICAL", "HIGH", "MEDIUM", "LOW"];
                reportEl.querySelectorAll("td, p, li, strong").forEach(function (el) {
                    var html = el.innerHTML;
                    levels.forEach(function (level) {
                        var regex = new RegExp("\\b" + level + "\\b", "g");
                        html = html.replace(regex, "<span class='badge " + level.toLowerCase() + "'>" + level + "</span>");
                    });
                    el.innerHTML = html;
                });
            }

            applyTheme();

            if (!isSafePath(file)) {
                statusEl.textContent = t("report.invalid_file", "Invalid file. Use ?file=reports/before.md");
                return;
            }

            fileLabel.textContent = file;
            fetch(file, { cache: "no-store" })
                .then(function (res) {
                    if (!res.ok) throw new Error("not found");
                    return res.text();
                })
                .then(function (text) {
                    statusEl.textContent = "";
                    if (window.marked) {
                        reportEl.innerHTML = window.marked.parse(text);
                    } else {
                        reportEl.textContent = text;
                    }
                    applyBadges();
                    buildToc();
                    applyTheme();
                })
                .catch(function () {
                    statusEl.textContent = t("report.load_error", "Could not load report. Verify file in docs/reports.");
                });
        })();
    </script>
</body>

</html>


